<!DOCTYPE html>
<html lang = "en" class="tas-com">
<head>
	<meta charset="utf-8">
	<title>D3: Adding Elements in D3</title>
	<link href="./themes/prism.css" rel="stylesheet" />
	<link href="./themes/tas_style.css" rel="stylesheet" />
	<script type="text/javascript" src="./d3/d3_version5.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<!-- Style axes -->
	<style>
		.axis path,
		.axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}

		.axis text {
			font-family: sans-serif;
			font-size: 12px;
		}
	</style>
</head>
<body>

	<h1>Bar graph</h1>
	
	<div id="q1">
	<h3 id="year_header">Year: 2007 - 2017</h3>

	<script type="text/javascript">

		// Define margins
		var marginBar = {
		    top: 20,
		    right: 10,
		    bottom: 20,
		    left: 10
		};

		// Width and height0
		var outerWidthBar = 400;
		var outerHeightBar = 600;
		var svgWidthBar = outerWidthBar - marginBar.left - marginBar.right;
		var svgHeightBar = outerHeightBar - marginBar.top - marginBar.bottom;

		// Create SVG element
		var svgBar = d3.select("aside")
		    .append("svg")
		    .attr("width", outerWidthBar)
		    .attr("height", outerHeightBar)
		    .append("g")
		    .attr("transform", "translate(" + marginBar.left + "," + marginBar.top + ")");

		// Create scale functions
		// Define domain inside the generateVis function below
		var xScaleBar = d3.scaleLog()
		    .range([0, svgWidthBar]);

		var yScaleBar = d3.scaleLinear()
		    .range([svgHeightBar, 0]);

		// Define axes
		var xAxisBar = d3.axisBottom()
		    .scale(xScaleBar)

		var yAxisBar = d3.axisLeft()
		    .scale(yScaleBar)
		    .ticks(5);

		// Year to display
		var displaYear = 2008;

		// Countries which are selected in the Search List
		checkedCountries = new Set([]);

		function yearFilter(value) {
	    return (value.Year == displayYear 
	        && value.GDP != 0 && value.Global_Competitiveness_Index != 0 && value.Population != 0) 
		}

		// Function to draw chart
		function generateVis() {

			// Filter data to only include current data
			var filtered_dataset = dataset.filter(yearFilter);


			/********** PERFORM DATA JOIN **********/
			// Join new data with old elements, if any.
			var bars = svg.selectAll("rect")
							.data(filtered_dataset, function key(d) {
								return d.Country;
							})


			/********** HANDLE UPDATE SELECTION **********/
			// Update the display of existing elements
			bars.attr("x", 0)
				.attr("y", function(d) {
					return y_scale(d.Country);
				})
				.attr("width", function(d) {
					return x_scale(+d.Population);
				})
				.attr("height", y_scale.bandwidth() - 5)
				.style("fill", "green");


			/********** HANDLE ENTER SELECTION **********/
			// Create new elements in the dataset
			bars.enter()
				.append("rect")
				.attr("x", 0)
				.attr("y", function(d) {
					return y_scale(d.Country);
				})
				.attr("width", function(d) {
					return x_scale(+d.Population);
				})
				.attr("height", y_scale.bandwidth() - 5)
				.style("fill", "blue");


			/********** HANDLE EXIT SELECTION **********/
			bars.exit().remove();


			// Set year label
			d3.select("#year_header").text("Year: " + display_year)
		}

		// Load file and generate visualisation based on it
		d3.csv("./data/Top10WorldPopulations2005_2015.csv")
			.then(function(data) {
				// console.log(data);
				dataset = data;

				// Update domain of x scale
				y_scale.domain(dataset.map(function(d) {
					return d.Country;
				}));

				// Call the y-axis
				svg.select("#y_axis").call(y_axis);

				// Generate the visualisation
				generateVis();

				// Iterate through available years
				setInterval(function() {
					display_year = display_year + 1;
					if(display_year > 2015) {
						display_year = 2005;
					}
					generateVis();
				}, 200);

			});

	</script>
	</div>

</body>
</html>